# requires fluent-plugin-github-activities

# for students
<source>
  type github-activities
  # Authentication is strongly recommended, because there is a rate limit: 60requests/hour by default.
  # With authentication, it becomes 5000requests/hour (means about 80requests/minute).
  # See following the GitHub help about access_token
  #   https://help.github.com/articles/creating-an-access-token-for-command-line-use/
  access_token access-token-of-github
  users min-shin,myokoym,okkez,piroor
  include_foreign_commits true
  clients 3
  interval 2
  base_tag github-activity.student.
  pos_file /var/log/td-agent/github-activities-student.json
</source>

# for mentors
<source>
  type github-activities
  access_token access-token-of-github
  users ashie,cosmo0920,kenhys,kou
  include_foreign_commits true
  clients 2
  interval 2
  base_tag github-activity.mentor.
  pos_file /var/log/td-agent/github-activities-mentor.json
</source>


# copy record for event, tag, and actor (requires fluent-plugin-map)

<match github-activity.**>
  type copy

  # record for the Events table
  <store>
    type   map
    tag    ("event.#{tag}")
    time   time
    record record
  </store>

  # record for the Actors table
  <store>
    type   map
    tag    ("actor.#{tag}")
    time   time
    record record
  </store>

  # record for the Tags table
  <store>
    type   map
    tag    '"repository-tag.#{tag}"'
    time   time
    record record
  </store>
</match>



# mapping rules for events (requires fluent-plugin-map)


## commit and push

<match event.github-activity.*.push>
  type map
  # You cannot define a string literal starting with double quote directly...
  tag ("sharetary.#{tag}")
  time time
  # You cannot use embedding patterns like "prefix #{variable}" because fluentd recognizes "#" mark next to a whitespace as the start of the comment of the line.
  # Instead you must use concatenation of strings like: '"prefix " + variable'
  record (require("time") || true) && { "_key" => "https://github.com/#{record["repo"]["name"]}/compare/#{record["payload"]["before"]}...#{record["payload"]["head"]}", "class" => "minor", "tags" => [record["repo"]["name"]], "title" => "Push", "description" => "Pushed " + record["payload"]["size"].to_s + " commits to " + record["repo"]["name"], "actor" => record["actor"]["login"], "uri" => "https://github.com/#{record["repo"]["name"]}/compare/#{record["payload"]["before"]}...#{record["payload"]["head"]}", "reply_uri" => "https://github.com/#{record["repo"]["name"]}/compare/#{record["payload"]["before"]}...#{record["payload"]["head"]}#commits_bucket", "timestamp" => Time.parse(record["created_at"]).to_i }
</match>

<match event.github-activity.*.commit>
  type map
  tag ("sharetary.#{tag}")
  time time
  record (require("time") || true) && { "_key" => record["html_url"], "class" => "normal", "tags" => [record["url"].match(/repos\/([^\/]+\/[^\/]+)\/commits/)[1]], "title" => "Commit " + record["stats"]["total"].to_s + " changes", "description" => record["commit"]["message"], "extra_description" => record["files"].collect{|file| "#{file["filename"]} (#{file["status"]})" }.join("\n, ") + "\n\n" + record["files"].collect{|file| file["patch"] }.join("\n\n"), "actor" => record["committer"]["login"], "uri" => record["html_url"], "reply_uri" => "#{record["html_url"]}#new_commit_comment_field", "timestamp" => Time.parse(record["commit"]["committer"]["date"]).to_i, "parent" => record["$github-activities-related-event"] && "https://github.com/#{record["$github-activities-related-event"]["repo"]["name"]}/compare/#{record["$github-activities-related-event"]["payload"]["before"]}...#{record["$github-activities-related-event"]["payload"]["head"]}" || nil }
</match>


## comments on commits

<match event.github-activity.*.commit-comment>
  type map
  tag ("sharetary.#{tag}")
  time time
  record (require("time") || true) && { "_key" => record["payload"]["comment"]["html_url"], "class" => "major", "tags" => [record["repo"]["name"]], "title" => "Commented to the commit " + record["repo"]["name"] + "/#{record["payload"]["comment"]["commit_id"]}", "description" => record["payload"]["comment"]["body"], "actor" => record["actor"]["login"], "uri" => record["payload"]["comment"]["html_url"], "reply_uri" => "#{record["payload"]["comment"]["html_url"].split("#").first}#new_commit_comment_field", "timestamp" => Time.parse(record["created_at"]).to_i, "parent" => record["payload"]["comment"]["html_url"].split("#").first }
</match>


## issues

<match event.github-activity.*.issue-open>
  type map
  tag ("sharetary.#{tag}")
  time time
  record (require("time") || true) && { "_key" => record["payload"]["issue"]["html_url"], "class" => "major", "tags" => [record["repo"]["name"]], "title" => "Open", "description" => "Opened new issue: " + "#" + record["payload"]["issue"]["number"].to_s + " " + record["payload"]["issue"]["title"] + ": " + (record["payload"]["issue"]["body"] || ""), "actor" => record["actor"]["login"], "uri" => record["payload"]["issue"]["html_url"], "reply_uri" => "#{record["payload"]["issue"]["html_url"].split("#").first}#new_comment_field", "timestamp" => Time.parse(record["created_at"]).to_i }
</match>

<match event.github-activity.*.issue-close>
  type map
  tag ("sharetary.#{tag}")
  time time
  record (require("time") || true) && { "_key" => record["payload"]["issue"]["html_url"] + "#" + Time.parse(record["payload"]["issue"]["updated_at"]).to_i.to_s, "class" => "major", "tags" => [record["repo"]["name"]], "title" => "Close", "description" => "Closed the issue: " + "#" + record["payload"]["issue"]["number"].to_s + " " + record["payload"]["issue"]["title"], "actor" => record["actor"]["login"], "uri" => record["payload"]["issue"]["html_url"], "reply_uri" => "#{record["payload"]["issue"]["html_url"].split("#").first}#new_comment_field", "timestamp" => Time.parse(record["created_at"]).to_i, "parent" => record["payload"]["issue"]["html_url"] }
</match>

<match event.github-activity.*.issue-reopen>
  type map
  tag ("sharetary.#{tag}")
  time time
  record (require("time") || true) && { "_key" => record["payload"]["issue"]["html_url"] + "#" + Time.parse(record["payload"]["issue"]["updated_at"]).to_i.to_s, "class" => "major", "tags" => [record["repo"]["name"]], "title" => "Reopen", "description" => "Reopened the issue: " + "#" + record["payload"]["issue"]["number"].to_s + " " + record["payload"]["issue"]["title"], "actor" => record["actor"]["login"], "uri" => record["payload"]["issue"]["html_url"], "reply_uri" => "#{record["payload"]["issue"]["html_url"].split("#").first}#new_comment_field", "timestamp" => Time.parse(record["created_at"]).to_i, "parent" => record["payload"]["issue"]["html_url"] }
</match>

<match event.github-activity.*.issue-comment>
  type map
  tag ("sharetary.#{tag}")
  time time
  record (require("time") || true) && { "_key" => record["payload"]["comment"]["html_url"], "class" => "major", "tags" => [record["repo"]["name"]], "title" => "Comment to " + "#" + record["payload"]["issue"]["number"].to_s + " " + record["payload"]["issue"]["title"], "description" => record["payload"]["comment"]["body"], "actor" => record["actor"]["login"], "uri" => record["payload"]["comment"]["html_url"], "reply_uri" => "#{record["payload"]["comment"]["html_url"].split("#").first}#new_comment_field", "timestamp" => Time.parse(record["created_at"]).to_i, "parent" => record["payload"]["issue"]["html_url"] }
</match>


## pull requests

<match event.github-activity.*.pull-request>
  type map
  tag ("sharetary.#{tag}")
  time time
  record (require("time") || true) && { "_key" => record["payload"]["pull_request"]["html_url"], "class" => "important", "tags" => [record["repo"]["name"]], "title" => "PR", "description" => "Created new pull-request: " + "#" + record["payload"]["pull_request"]["number"].to_s + " " + record["payload"]["pull_request"]["title"] + ": " + (record["payload"]["pull_request"]["body"] || ""), "actor" => record["actor"]["login"], "uri" => record["payload"]["pull_request"]["html_url"], "reply_uri" => "#{record["payload"]["pull_request"]["html_url"].split("#").first}#new_comment_field", "timestamp" => Time.parse(record["created_at"]).to_i }
</match>

<match event.github-activity.*.pull-request-reopen>
  type map
  tag ("sharetary.#{tag}")
  time time
  record (require("time") || true) && { "_key" => record["payload"]["pull_request"]["html_url"] + "#" + Time.parse(record["payload"]["pull_request"]["updated_at"]).to_i.to_s, "class" => "important", "tags" => [record["repo"]["name"]], "title" => "PR Reopen", "description" => "Reopened the pull-request " + "#" + record["payload"]["pull_request"]["number"].to_s + " " + record["payload"]["pull_request"]["title"], "actor" => record["actor"]["login"], "uri" => record["payload"]["pull_request"]["html_url"], "reply_uri" => "#{record["payload"]["pull_request"]["html_url"].split("#").first}#new_comment_field", "timestamp" => Time.parse(record["created_at"]).to_i, "parent" => record["payload"]["pull_request"]["html_url"] }
</match>

<match event.github-activity.*.pull-request-merged>
  type map
  tag ("sharetary.#{tag}")
  time time
  record (require("time") || true) && { "_key" => record["payload"]["pull_request"]["html_url"] + "#" + Time.parse(record["payload"]["pull_request"]["updated_at"]).to_i.to_s, "class" => "important", "tags" => [record["repo"]["name"]], "title" => "PR Merge", "description" => "Merged the pull-request \"#" + record["payload"]["pull_request"]["number"].to_s + " " + record["payload"]["pull_request"]["title"], "actor" => record["actor"]["login"], "uri" => record["payload"]["pull_request"]["html_url"], "reply_uri" => "#{record["payload"]["pull_request"]["html_url"].split("#").first}#new_comment_field", "timestamp" => Time.parse(record["created_at"]).to_i, "parent" => record["payload"]["pull_request"]["html_url"] }
</match>

<match event.github-activity.*.pull-request-cancelled>
  type map
  tag ("sharetary.#{tag}")
  time time
  record (require("time") || true) && { "_key" => record["payload"]["pull_request"]["html_url"] + "#" + Time.parse(record["payload"]["pull_request"]["updated_at"]).to_i.to_s, "class" => "important", "tags" => [record["repo"]["name"]], "title" => "PR Cancel", "description" => "Cancelled the pull-request \"#" + record["payload"]["pull_request"]["number"].to_s + " " + record["payload"]["pull_request"]["title"], "actor" => record["actor"]["login"], "uri" => record["payload"]["pull_request"]["html_url"], "reply_uri" => "#{record["payload"]["pull_request"]["html_url"].split("#").first}#new_comment_field", "timestamp" => Time.parse(record["created_at"]).to_i, "parent" => record["payload"]["pull_request"]["html_url"] }
</match>

<match event.github-activity.*.pull-request-comment>
  type map
  tag ("sharetary.#{tag}")
  time time
  record (require("time") || true) && { "_key" => record["payload"]["comment"]["html_url"], "class" => "important", "tags" => [record["repo"]["name"]], "title" => "PR Comment " + "#" + record["payload"]["issue"]["number"].to_s + " " + record["payload"]["issue"]["title"], "description" => record["payload"]["comment"]["body"], "actor" => record["actor"]["login"], "uri" => record["payload"]["comment"]["html_url"], "reply_uri" => "#{record["payload"]["comment"]["html_url"].split("#").first}#new_comment_field", "timestamp" => Time.parse(record["payload"]["comment"]["created_at"]).to_i, "parent" => record["payload"]["issue"]["pull_request"]["html_url"] }
</match>


## fork

<match event.github-activity.*.fork>
  type map
  tag ("sharetary.#{tag}")
  time time
  record (require("time") || true) && { "_key" => "#{record["payload"]["forkee"]["html_url"]}#forked", "class" => "normal", "tags" => [record["payload"]["forkee"]["full_name"]], "title" => "Fork", "description" => "Forked the repository " + record["repo"]["name"] + " to " + record["payload"]["forkee"]["full_name"], "actor" => record["actor"]["login"], "uri" => "#{record["payload"]["forkee"]["html_url"] }#forked", "timestamp" => Time.parse(record["created_at"]).to_i }
</match>


## branch, tag

<match event.github-activity.*.branch>
  type map
  tag ("sharetary.#{tag}")
  time time
  record (require("time") || true) && { "_key" => "https://github.com/#{record["repo"]["name"]}/tree/#{record["payload"]["ref"]}", "class" => "normal", "tags" => [record["repo"]["name"]], "title" => "Branch", "description" => "Created new branch " + record["payload"]["ref"] + " at the repository " + record["repo"]["name"], "actor" => record["actor"]["login"], "uri" => "https://github.com/#{record["repo"]["name"]}/tree/#{record["payload"]["ref"]}", "timestamp" => Time.parse(record["created_at"]).to_i }
</match>

<match event.github-activity.*.tag>
  type map
  tag ("sharetary.#{tag}")
  time time
  record (require("time") || true) && { "_key" => "https://github.com/#{record["repo"]["name"]}/tree/#{record["payload"]["ref"]}", "class" => "normal", "tags" => [record["repo"]["name"]], "title" => "Tag", "description" => "Created new tag " + record["payload"]["ref"] + " at the repository " + record["repo"]["name"], "actor" => record["actor"]["login"], "uri" => "https://github.com/#{record["repo"]["name"]}/tree/#{record["payload"]["ref"]}", "timestamp" => Time.parse(record["created_at"]).to_i }
</match>


# complete common fields  and adding extra tag (requires fluent-plugin-map)

<match sharetary.event.github-activity.*.**>
  type map
  tag ("completed.#{tag}")
  time time
  record (require("time") || true) && record.merge("type" => tag.split(".")[3], "source" => "https://github.com/favicon.ico", "created_at" => Time.now.to_i, "tags" => record["tags"] + ["sample-extra-tag"])
</match>


# complete common fields and adding extra tag (requires fluent-plugin-map)

<match sharetary.event.github-activity.*.**>
  type map
  tag ("sharetary.event")
  time time
  record (require("time") || true) && record.merge("type" => tag.split(".")[4], "source" => "https://github.com/favicon.ico", "created_at" => Time.now.to_i, "tags" => record["tags"] + ["sample-extra-tag"])
</match>





# storing event into Groonga's database (requires fluent-plugin-groonga)

<match sharetary.event>
  type groonga
  store_table Events

  protocol http
  host localhost

  buffer_type file
  buffer_path /var/spool/td-agent/buffer/groonga-sharetary-event
  flush_interval 1s

  <table>
    name Events
    flags TABLE_HASH_KEY
    key_type ShortText
  </table>

  <table>
    name Timestamps
    flags TABLE_PAT_KEY
    key_type Time
  </table>

  <table>
    name Tags
    flags TABLE_HASH_KEY
    key_type ShortText
  </table>

  <table>
    name Actors
    flags TABLE_HASH_KEY
    key_type ShortText
  </table>

  <table>
    name Terms
    flags TABLE_PAT_KEY
    key_type ShortText
    default_tokenizer TokenBigram
    normalizer NormalizerAuto
  </table>

  <mapping>
    name type
    type ShortText
  </mapping>

  <mapping>
    name class
    type ShortText
  </mapping>

  <mapping>
    name title
    type ShortText
    <index>
      table Terms
      name Events_title_index
      flags WITH_POSITION
    </index>
  </mapping>

  <mapping>
    name description
    type Text
    <index>
      table Terms
      name Events_description_index
      flags WITH_POSITION
    </index>
  </mapping>

  <mapping>
    name extra_description
    type Text
    <index>
      table Terms
      name Events_extra_description_index
      flags WITH_POSITION
    </index>
  </mapping>

  <mapping>
    name tags
    type Tags
    <index>
      table Tags
      name Events_tags_index
    </index>
  </mapping>

  <mapping>
    name uri
    type ShortText
    <index>
      table Terms
      name Events_uri_index
      flags WITH_POSITION
    </index>
  </mapping>

  <mapping>
    name source_icon
    type ShortText
  </mapping>

  <mapping>
    name reply_uri
    type ShortText
  </mapping>

  <mapping>
    name actor
    type Actors
    <index>
      table Actors
      name Events_actor_index
    </index>
  </mapping>

  <mapping>
    name timestamp
    type Time
    <index>
      table Timestamps
      name Events_timestamp_index
    </index>
  </mapping>

  <mapping>
    name created_at
    type Time
    <index>
      table Timestamps
      name Events_created_at_index
    </index>
  </mapping>

  <mapping>
    name parent
    type ShortText
    <index>
      table Terms
      name Events_parent_index
      flags WITH_POSITION
    </index>
  </mapping>
</match>



# tags

<match repository-tag.github-activity.*.commit>
  type map
  tag  ("sharetary.tag")
  time time
  record ({ "_key" => record["url"].match(/repos\/([^\/]+\/[^\/]+)\/commits/)[1], "icon" => record["$github-activities-related-organization-logo"] })
</match>

<match repository-tag.github-activity.*.fork>
  type map
  tag  ("sharetary.tag")
  time time
  record ({ "_key" => record["payload"]["forkee"]["full_name"], "icon" => record["$github-activities-related-organization-logo"] })
</match>

<match repository-tag.**>
  type map
  tag  ("sharetary.tag")
  time time
  record ({ "_key" => record["repo"]["name"], "icon" => record["$github-activities-related-organization-logo"] })
</match>

<match sharetary.tag>
  type groonga
  store_table Tags

  protocol http
  host localhost

  buffer_type file
  buffer_path /var/spool/td-agent/buffer/groonga-sharetary-tag
  flush_interval 1s

  <table>
    name Tags
    flags TABLE_HASH_KEY
    key_type ShortText
  </table>

  <mapping>
    name icon
    type ShortText
  </mapping>
</match>



# actor

<match actor.github-activity.student.**>
  type map
  tag  ("sharetary.actor")
  time time
  record ({ "_key" => (record["actor"] || record["committer"])["login"], "uri" => "https://github.com/#{(record["actor"] || record["committer"])["login"]}/", "icon" => record["$github-activities-related-avatar"], "class" => "major" })
</match>

<match actor.github-activity.mentor.**>
  type map
  tag  ("sharetary.actor")
  time time
  record ({ "_key" => (record["actor"] || record["committer"])["login"], "uri" => "https://github.com/#{(record["actor"] || record["committer"])["login"]}/", "icon" => record["$github-activities-related-avatar"], "class" => "minor" })
</match>

<match sharetary.actor>
  type groonga
  store_table Actors

  protocol http
  host localhost

  buffer_type file
  buffer_path /var/spool/td-agent/buffer/groonga-sharetary-actor
  flush_interval 1s

  <table>
    name Actors
    flags TABLE_HASH_KEY
    key_type ShortText
  </table>

  <mapping>
    name uri
    type ShortText
  </mapping>

  <mapping>
    name icon
    type ShortText
  </mapping>

  <mapping>
    name class
    type ShortText
  </mapping>
</match>
