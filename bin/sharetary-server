#!/usr/bin/env node
// -*- js -*-

var express = require('express');
var http = require('http');
var path = require('path');

var GroongaClient = require('../lib/groonga/client');
var groonga = new GroongaClient({
                base: 'http://localhost:10041'
              });

var application = express();
var server = http.createServer(application);

// application.enable('trust proxy');

var baseDir = path.join(__dirname, '..');
application.set('views', path.join(baseDir, 'views'));
application.set('view engine', 'jade');

application.get('/', function(request, response) {
  response.redirect('/timeline');
});
application.get('/timeline', function(request, response) {
  groonga.select({
    table:  'Events',
    sortby: '-timestamp',
    limit:  100
  }).then(function(result) {
    response.render('timeline', {
      title:   'Timeline',
      records: result.records
    });
  });
});
application.get('/archive', function(request, response) {
  groonga.select({
    table:  'Events',
    sortby: 'timestamp',
    limit:  -1
  }).then(function(result) {
    response.render('archive', {
      title:   'Archive',
      records: result.records
    });
  });
});

server.on('error', function(error) {
  server.close();
});
server.listen(11041, '0.0.0.0');

process.on('SIGINT', function() {
  server.close();
});

process.on('SIGTERM', function() {
  server.close();
});
