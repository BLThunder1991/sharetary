#!/bin/bash

GROONGA_HOST=$1
GROONGA_PORT=$2
: ${GROONGA_HOST:=localhost}
: ${GROONGA_PORT:=10041}

GROONGA="http://$GROONGA_HOST:$GROONGA_PORT/d"

echo "Preparing required tables..."
curl -s "$GROONGA/table_create?name=Tags&flags=TABLE_HASH_KEY&key_type=ShortText" > /dev/null
curl -s "$GROONGA/column_create?table=Tags&name=icon&flags=COLUMN_SCALAR&type=ShortText" > /dev/null

curl -s "$GROONGA/table_create?name=Actors&flags=TABLE_HASH_KEY&key_type=ShortText" > /dev/null
curl -s "$GROONGA/column_create?table=Actors&name=uri&flags=COLUMN_SCALAR&type=ShortText" > /dev/null
curl -s "$GROONGA/column_create?table=Actors&name=icon&flags=COLUMN_SCALAR&type=ShortText" > /dev/null
curl -s "$GROONGA/column_create?table=Actors&name=class&flags=COLUMN_SCALAR&type=ShortText" > /dev/null


echo "Creating a tags..."

tags=$(mktemp)
echo "[" >> "$tags"
curl -s "$GROONGA/select?table=Events&limit=0&drilldown=scope&drilldown_limit=-1&drilldown_output_columns=_key" | jq ".[1][1][3:][][]" | while read scope
do
  icon=$(curl -s "$GROONGA/select?table=Events&limit=1&filter=scope==$scope&output_columns=scope_icon" | jq ".[1][0][2][]")
  echo "[$scope,$icon]," >> "$tags"
done
echo "]" >> "$tags"
curl -d "@$tags" -s "$GROONGA/load?table=Tags&columns=_key,icon" > /dev/null
rm "$tags"


echo "Creating actors..."

actors=$(mktemp)
echo "[" >> "$actors"
curl -s "$GROONGA/select?table=Events&limit=0&drilldown=actor&drilldown_limit=-1&drilldown_output_columns=_key" | jq ".[1][1][3:][][]" | while read actor
do
  echo "[$actor", >> "$actors"
  for field in $(curl -s "$GROONGA/select?table=Events&limit=1&filter=actor==$actor&output_columns=actor_icon,actor_uri,actor_class" | jq ".[1][0][2][]")
  do
    echo ",$field" >> "$actors"
  done
  echo "]," >> "$actors"
done
echo "]" >> "$actors"
curl -d "@$actors" -s "$GROONGA/load?table=Actors&columns=_key,icon,uri,class" > /dev/null
rm "$actors"


echo "Migrating actor related columns..."

curl -s "$GROONGA/column_rename?table=Events&name=actor&new_name=old_actor" > /dev/null
curl -s "$GROONGA/column_create?table=Events&name=actor&flags=COLUMN_SCALAR&type=Actors" > /dev/null
events=$(mktemp)
echo "[" >> "$events"
curl -s "$GROONGA/select?table=Events&limit=-1&output_columns=_key,old_actor" | jq -c ".[1][0][2:][]" | while read record
do
  key=$(echo "$record" | jq ".[0]")
  actor=$(echo "$record" | jq ".[1]")
  echo "[$key,$actor]," >> "$events"
done
echo "]" >> "$events"
curl -d "@$events" -s "$GROONGA/load?table=Events&columns=_key,actor" > /dev/null
rm "$events"


echo "Migrating scope to tags..."

curl -s "$GROONGA/column_create?table=Events&name=tags&flags=COLUMN_VECTOR&type=Tags" > /dev/null
events=$(mktemp)
echo "[" >> "$events"
curl -s "$GROONGA/select?table=Events&limit=-1&output_columns=_key,scope" | jq -c ".[1][0][2:][]" | while read record
do
  key=$(echo "$record" | jq ".[0]")
  scope=$(echo "$record" | jq ".[1]")
  echo "[$key,[$scope]]," >> "$events"
done
echo "]" >> "$events"
curl -d "@$events" -s "$GROONGA/load?table=Events&columns=_key,tags" > /dev/null
rm "$events"


echo "Migrating indexes..."

curl -s "$GROONGA/column_remove?table=Terms&name=Events_actor_index" > /dev/null
curl -s "$GROONGA/column_create?table=Actors&name=Events_actor_index&flags=COLUMN_INDEX&type=Events&source=actor" > /dev/null
curl -s "$GROONGA/column_create?table=Tags&name=Events_tags_index&flags=COLUMN_INDEX&type=Events&source=tags" > /dev/null

